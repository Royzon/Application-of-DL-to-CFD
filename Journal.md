
### How to install OpenFOAM on Arch linux
1. Enable the Loop Module

check:
```shell
# lsmod | grep loop
```
If the loop module doesn't loaded, run the code below:
```shell
# tee /etc/modules-load.d/loop.conf <<< "loop"
# modprobe loop
```

2. Install Docker
```shell
# pacman -S docker
```

3. start/enable/stop Docker
```shell
# systemctl start docker.service
 
# systemctl enable docker.service

# systemctl stop docker.service
```
Then we check the docker info with
```shell
# docker info
```

4. Grand user with docker group
```shell
# groupadd docker
 
# gpasswd -a user docker [replace user with your username]
``` 

5. Download OpenFoam scripts to load and run OpenFoam
* Download two scripts
[installOpenFOAM](https://sourceforge.net/projects/openfoamplus/files/v1806/installOpenFOAM)
[startOpenFOAM](https://sourceforge.net/projects/openfoamplus/files/v1806/startOpenFOAM)

* Make two scripts executable
```shell
chmod +x installOpenFOAM 
chmod +x startOpenFOAM 
```

* Run install script
```shell
./installOpenFOAM
```

* Run start script
```shell
./startOpenFOAM
```

6. Test
```shell
mkdir -p $FOAM_RUN 
run 
cp -r $FOAM_TUTORIALS/incompressible/icoFoam/cavity/cavity . 
cd cavity 
blockMesh 
icoFoam 
```
7. Copy tutorial
``` shell
mkdir -p $FOAM_RUN 
cp -r $FOAM_TUTORIALS $FOAM_RUN
```
### How blockMesh works
1. where is mesh?
Mesh is generated by `blockMeshDict` located in the `system` folder, which decompose the domain geometry into a set of 1 or more three dimesional, hexahedral blocks. Each block is defined by 8 vertices(less than 8 vertices is possible).

#### Block coordinate system
1. It is a [right-handed](https://www.evl.uic.edu/ralph/508S98/coordinates.html).
2. Order to write the vertices
    * vertex 0
    * Move 0 to 1 by x axis
    * Move 1 to 2 by y axis
    * 0,1,2,3 define a plane
    * then 4,5,6,7 define other planes.

#### Meaning of blockMeshDict

* scale: scaling factor. eg. 0.001=mm, 1=meter
* vertice: list of vertex in 3D
* edges: arc or spline edges. 
    * edge type: arc, spline, polyline,BSpline,line(default)
    * eg. arc 1 5 (1.1 0.0 0.5) connect the vertex 1 and 5 with interpolation point(1.1 0.0 0.5)
* block: ordered list of vertex labels and mesh size. eg. `hex (0 1 2 3 4 5 6 7) (20 20 1) simpleGrading (1 1 1)` means vertex 0 to 7 to form a block, (20 20 1) defines numbers of cells in the order of x1,x2,x3. The last part `simpleGrading (1 1 1)` is cell expansion ratios, which is length of last block divded by the first one. More advanced information we can refer to `edgeGrading` and `multi-grading` to set up expansion ratios for each edge.
``` c
blocks
(
hex (0 1 2 3 4 5 6 7) (100 300 100)
simpleGrading
(
1 // x-direction expansion ratio
(
(0.2 0.3 4) // 20% y-dir, 30% cells, expansion = 4
(0.6 0.4 1) // 60% y-dir, 40% cells, expansion = 1
(0.2 0.3 0.25) // 20% y-dir, 30% cells, expansion = 0.25 (1/4)
)
3 // z-direction expansion ratio
)
);
```
* boundary: boundary is broken into patches. Each patche has its name, type and faces. 
``` c
boundary
(
    movingWall  // patch name
    {
        type wall; // patch type
        faces
        (
            //looking from inside the block and starting with any vertex, the
 face must be traversed in a clockwise direction 
            (3 7 6 2)  
        );
    }
  .........  
);
```
* mergePatchpairs:used in face merging.`need to be fulfilled`

#### Initial conditions
Once setting up the mesh, we can run `blockMesh` under project folder, and get the inital status files(p and U) in a 0 sub-folder. Let's see the content of p:
``` c
// dimensinSet is 7 scalars delimited by square brackets, here is m^2s^{-2} to get kinematic pressure
dimensions      [0 2 -2 0 0 0 0];

internalField   uniform 0;

boundaryField
{
    movingWall
    {
        // the normal gradient of pressure is 0
        type            zeroGradient;
    }

    fixedWalls
    {
        type            zeroGradient;
    }

    frontAndBack
    {
        type            empty;
    }
}

```
### OpenFOAM Structure
![img](/img/OpenFOAM-structure.png)

![folder structure](/img/foamFolderStructure.png)

reference: http://www.cfdyna.com/Home/OpenFOAM.html

The meaning of some important files:
* `system/controlDict`: control time, reading & writing soltuion data.
* `system/blockMeshDict`: describing the geometry. Command `blockMesh` to generate mesh by this file.
* `system/setFieldDict`: assign value to regions. Command `setFields` to call this setting.
* `constant/polyMesh`: describing the geometry of polyhedral
* `0/p` or `0/U`: boundary condition setting and flow field initialization files. p for pressure, U for velocity. Unit of variable is a row vector with 7 elements in order of: _Mass Length Time Temperature Quantity Current Luminous Intensity_. Other files in `0` folder: k - Kinematic energy, T - temperature.
* `system/fvSchemes`: terms, schemes, numerical setting
* `system/fvSolution`: tolerance, algorithms, and solvers controls
* `system/decomposeParDict`: setting decomposition of mesh for paralell computing

### Step by Step for OpenFOAM
1. Pre-processing
* definition of the `geometry` of the region and `grid` generation using `blockMesh` utility to create geometry and mesh
  * `system/blockMeshDict` for mesh generation
    * variables can be defined 
    ``` c++
    var(
       vari1 10;
       vari2 20;
       vari3 #calc "$vari1+$var15";
    vertices(
       ($:var.vari3 0 0)
    }
    ```
    * If the domian is 2D, we only need to set grid in z-axis as 1:
    ``` c++
    blocks
    (
    hex (0 1 3 2 8 9 11 10) (25 10 1) simpleGrading (1 1 1)
    hex (2 3 6 5 10 11 14 13) (25 40 1) simpleGrading (1 1 1)
    hex (3 4 7 6 11 12 15 14) (100 40 1) simpleGrading (1 1 1)
    );
    ```
    * After setting mesh by `blockMeshDic`, we need to run command `blockMesh` to create mesh.
    * `system/setFieldsDict`:is used by the tool setFields for patching (assign an amount to a region) in the simulation. In this file, we can find two sectors, one is `defaultFieldValues` which is a value assigned to whole domain; anonther is `regions` which a spec value to spec region. After run `setFields`, the value will be assigned and folder `0` will be changed as well.
* Viscous `model`, `fluid propeties` and `boundary conditions`
  * `constant/transportProperties` for fluid properties
  ``` C++
  // nu is the fluid kinematic viscosity, which is 0.01 m2/s for this example.
  nu [ 0 2 -1 0 0 0 0 ] 0.01;
  // diffusion coefficient
  DT [ 0 2 -1 0 0 0 0] 0.001;
  ```
  * `constant/turbulenceProperties` for turbulence model selection
  * `constant/thermophysicalProperties`for compressible gas whose material properties that vary with temperature.
  * `0` folder:
     * dimensions: SI unite with a vector consists of 7 elements.
     * internalField: uniform or non-uniform
     * boundaryField: zeroGradient, fixedValue or empty(for side)
2. Slover setting
 * four distinct streams of numerical solution tech: `finite difference, finite element, spectral methods and finite volume`. We only need to focus on `finite volumne`, which consists of the following steps:
    * Integration of the conservation of mass, energy and momentum equation over all the control volumes in the domain.
    * Discretization
    * iterative
 * `system/controlDict`: discretization scheme
 * `system/fvSchemes`:the settings to the coupling method of pressure and velocity,
the numerical methods, and final tolerance for convergence of that quantity
 * `system/fvSolution`: time control, saving interval, file format...
3. Post-processing
 * by typing the solver's name we can executing the solutions,e.g, icoFoam
 * if mesh created by __GAMBIT__, we need to use `fluentMeshToFoam` to transfer mesh into `system/polyMesh`. Otherwise, just run `blockMesh` to get mesh from `blockMeshDict`.
 * create file dummy file `foam.foam`, and execute `paraview foam.foam &` to visualze the result
 * load this file by ParaView, the animation will look like this :
 
 ![demo](/img/demoparaview.png)
 
 * we can also use command `refineMesh` to refine the mesh, the result looks like this:
 
 ![demo](/img/demoparaview2.png)
 
### Runnning Parallel
1. Decomposite mesh using `system/decomposeParDict`. Basicly, we need to choose method and its coefficients. More detail about paramater see [referce](https://cfd.direct/openfoam/user-guide/v6-running-applications-parallel/). The example is a example we use 8 subdomain(processors) with simple method in which coefficients are set as (2,4,1) in x,y,z directions.
```
numberOfSubdomains 8;

method          simple;

simpleCoeffs
{
    n               (2 4 1 ); //2*4*1=8
    delta           0.001;
}
```
2. run `decomposePar` to 

 
### Others
* `#inculde` is as same as in C
* use `paraview -block` to visualize `blockMeshdic` where we can find the order of points.

### Case study
1. tuturial can be found `tutorials/multiphase/interFoam/laminar/damBreak/damBreak/`
We set water zone through `setFiledsDic`
``` c++
defaultFieldValues
(
// default without water
    volScalarFieldValue alpha.water 0
);

regions
(
    boxToCell
    {
        box (0 0 -1) (0.1461 0.292 1);
        fieldValues
        (
            //water zone
            volScalarFieldValue alpha.water 1
        );
    }
);
```
 ![demo](/img/ani-bam.gif)
 
 2. create by gmsh, where flow from left side with speed of 1m/s.
  ![demo](/img/ani.gif)
